---
import Layout from '../layouts/Layout.astro'
---

<Layout title="Welcome to Astro.">
  <main>
    <div class="mt-24 ml-8">
      <h1>Power AI</h1>
      <input type="text" />
      <button>go</button>
      <p>This is answer of AI :</p>
      <p class="max-[100vw] flex-wrap" id="result">...</p>
      <img id="img" src="" alt="ai" />
    </div>
  </main>
</Layout>

<script>
  const button = document.querySelector('button')!
  const input = document.querySelector('input')!
  const result = document.querySelector('#result')!
  const img = document.querySelector('#img')!

  let loading = false

  const decoder = new TextDecoder()
  const reset = () => {
    result.innerHTML = '...'
    img.setAttribute('src', '')
  }

  button.addEventListener('click', async () => {
    loading = true
    button.disabled = true
    reset()
    const value = input.value
    const res = await fetch('/api/gentext', {
      method: 'POST',
      body: JSON.stringify({ messages: [{ role: 'user', content: value }] }),
      headers: {
        'Content-Type': 'application/json',
      },
    })
    let done = false
    const reader = res.body!.getReader()
    while (!done) {
      const { value, done: doneReading } = await reader.read()
      done = doneReading
      const chunkValue = decoder.decode(value)
      result.innerHTML += chunkValue
    }

    const imgRes = await fetch(`/api/genimg?prompt=${value}`)
    const r = await imgRes.json()
    img.setAttribute('src', r.data[0].url)
    loading = false
    button.disabled = false
  })
</script>
